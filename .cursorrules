# ============================================================
# LPBME 2.0 ‚Äî CURSOR RULES + PROJECT KNOWLEDGE (CAN√ìNICO)
# Proyecto: Los Pueblos M√°s Bonitos de Espa√±a
# Owner: Fran
# √öltima actualizaci√≥n: enero 2026
# ============================================================

#############################################################
# 1. VISI√ìN GENERAL DEL PROYECTO
#############################################################

LPBME 2.0 es la reconstrucci√≥n completa del ecosistema digital
de la asociaci√≥n "Los Pueblos M√°s Bonitos de Espa√±a".

Incluye:
- Web p√∫blica institucional
- Casa del Usuario (gamificaci√≥n, visitas, puntos)
- Panel de pueblos (alcaldes)
- Backend unificado
- App m√≥vil iOS y Android ya en producci√≥n

NO es un proyecto experimental.
Es un proyecto institucional, estable y a largo plazo.

La web debe:
- Funcionar SIEMPRE
- Ser robusta ante errores
- No depender de WordPress
- Compartir backend con la app m√≥vil

#############################################################
# 2. STACK TECNOL√ìGICO (DECISI√ìN FIRME)
#############################################################

BACKEND
- Node.js
- NestJS
- Prisma ORM
- PostgreSQL
- Deploy en Railway
- Puerto local: 3000

FRONTEND (WEB)
- Next.js 16
- App Router
- React Server Components
- TypeScript
- Tailwind CSS
- Deploy en Vercel
- Puerto local: 3001

APP
- React Native (Expo)
- Comparte backend con la web
- Ya en producci√≥n (iOS + Android)

NO se debe:
- Cambiar de stack
- Introducir frameworks nuevos
- Introducir CMS
- Volver a WordPress

#############################################################
# 3. PRINCIPIOS FUNDAMENTALES DE LA WEB
#############################################################

La web LPBME NO es:
- Una landing
- Un blog
- Un simple cat√°logo

Es un portal institucional + experiencial.

Principios:
- Contenido estructurado
- Datos normalizados
- Relaci√≥n directa con la app
- Escalable a futuro (club, premium, etc.)

La web debe poder:
- Funcionar sin backend temporalmente
- Mostrar fallbacks siempre
- No romper build jam√°s

#############################################################
# 4. ESTRUCTURA DE LA WEB (ALTO NIVEL)
#############################################################

P√°ginas principales:

- /
  Home institucional

- /pueblos
  Listado de pueblos

- /pueblos/[slug]
  Ficha de pueblo

- /rutas
  Listado de rutas

- /rutas/[slug]
  Ficha de ruta + mapa Boldest

- /entrar
  Login

- /cuenta
  Casa del usuario

- /admin (futuro)
  Gesti√≥n interna

#############################################################
# 5. HOME (MUY IMPORTANTE)
#############################################################

La Home:
- Es institucional
- No depende de autenticaci√≥n
- No debe romper build jam√°s

Contenido t√≠pico:
- Hero
- Mapa o acceso a mapa
- Destacados
- Rutas
- Pueblos
- CTA

Reglas t√©cnicas:
- dynamic = "force-dynamic"
- revalidate = 0
- cache: "no-store"
- Si backend falla ‚Üí mostrar contenido por defecto
- JAM√ÅS lanzar error en build

#############################################################
# 6. PUEBLOS
#############################################################

Entidad central del proyecto.

Cada Pueblo:
- Tiene slug √∫nico
- Tiene fotos
- Tiene POIs
- Tiene eventos
- Tiene noticias
- Tiene rutas asociadas
- Tiene visitas (gamificaci√≥n)

La ficha de pueblo:
- NO debe depender de WordPress
- NO debe hacer joins raros
- NO debe romper si faltan datos

Si algo falta:
- Se oculta
- Se muestra placeholder
- Nunca error

#############################################################
# 7. RUTAS (CLAVE)
#############################################################

Las rutas son entidades propias.

Tabla: Ruta

Campos importantes:
- id
- slug
- nombre
- foto_portada
- boldestMapId (RB-1, RB-2‚Ä¶)
- boldestMapSlug (slug REAL del mapa)

Las rutas:
- NO se crean din√°micamente
- Son exactamente 16 (por ahora)
- Vienen de WordPress legacy
- Ya est√°n migradas

#############################################################
# 8. MAPAS (BOLDEST)
#############################################################

Los mapas de rutas usan BOLDEST.

Reglas:
- El frontend NO inventa slugs
- El slug v√°lido est√° en BD (boldestMapSlug)
- Si boldestMapSlug es null:
  - Mostrar ‚ÄúMapa no disponible‚Äù
  - Nunca romper la p√°gina

El comportamiento debe ser:
- Igual al WordPress original
- Panel derecho scrollable
- Sin hacks reactivos innecesarios
- Priorizar estabilidad

#############################################################
# 9. CASA DEL USUARIO
#############################################################

La Casa del Usuario incluye:
- Perfil
- Pueblos visitados
- Visitas GPS vs manuales
- Puntos
- Notificaciones
- Futuro Club de Amigos

Es compartida con la app.

Reglas:
- Todo viene del backend
- El frontend solo pinta
- No duplicar l√≥gica
- No inventar puntos

#############################################################
# 10. BACKEND: FILOSOF√çA
#############################################################

El backend es la √öNICA fuente de verdad.

Debe:
- Arrancar siempre
- No crashear por configuraci√≥n incompleta
- Degradar servicios opcionales

Ejemplo:
- R2 / Media
  - Si falta config ‚Üí backend ARRANCA
  - Solo falla el upload con 503

Nunca:
- throw en constructor por env vars
- crash en startup
- loops de reinicio en Railway

#############################################################
# 11. MEDIA Y R2
#############################################################

Media usa Cloudflare R2.

Variables:
- R2_ACCOUNT_ID
- R2_ACCESS_KEY_ID
- R2_SECRET_ACCESS_KEY
- R2_BUCKET
- R2_PUBLIC_BASE_URL

Si faltan:
- r2Enabled = false
- s3 = null
- Backend sigue funcionando
- Upload devuelve 503

#############################################################
# 12. FRONTEND: FETCH Y BUILD
#############################################################

Regla de oro:
EL FRONTEND NO PUEDE ROMPER BUILD.

Nunca:
- throw en fetch en build
- asumir que el backend responde
- asumir que un endpoint existe

Siempre:
- comprobar res.ok
- devolver fallback
- usar cache: "no-store"

#############################################################
# 13. VARIABLES DE ENTORNO FRONTEND
#############################################################

- NEXT_PUBLIC_API_URL es OBLIGATORIA
- Puede ser:
  - https://backend.railway.app
  - https://backend.railway.app/api

Nunca asumir prefijos.

#############################################################
# 14. DEPLOY
#############################################################

FRONTEND
- Deploy autom√°tico desde GitHub
- Redeploy si no hay cambios:
  git commit --allow-empty -m "chore: redeploy"

BACKEND
- Deploy en Railway
- Logs claros
- Sin crash loops

#############################################################
# 14b. GIT ‚Äî NORMA B√ÅSICA
#############################################################

Al subir cambios a git:
- SIEMPRE hacer commit y push en AMBOS repositorios: backend Y frontend
- Backend y frontend son repos separados (lpmbe-backend, lpmbe-frontend)
- Si el cambio solo afecta a uno, igualmente verificar el otro (puede haber cambios pendientes)

#############################################################
# 15. ESTILO VISUAL
#############################################################

Dise√±o:
- Plano
- Sin sombras
- Sin tarjetas
- Sin iconos decorativos
- Sin animaciones gratuitas

Prioridad:
FUNCIONAR > SER BONITO

#############################################################
# 16. FILOSOF√çA FINAL
#############################################################

Este proyecto:
- No se reescribe
- No se reinventa
- No se ‚Äúoptimiza‚Äù por capricho

Cada cambio debe:
- Ser consciente
- Ser estable
- No romper nada existente

Si algo funciona:
NO SE TOCA.

#############################################################
# FIN DEL DOCUMENTO
############################################################# 

admin
 "email": franmestre@lospueblosmasbonitosdeespana.org
    "password": Fran2575
{"access_token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOjEsImVtYWlsIjoiYWRtaW5AbHBibWUuZXMiLCJyb2wiOiJBRE1JTiIsImlhdCI6MTc2NTgyMDkyMywiZXhwIjoxNzY2NDI1NzIzfQ.TOS3q-h7EWvasNAcZghf__jKOI68AEwHZgh6dTfvIwU","user":{"id":1,"email":"admin@lpbme.es","rol":"ADMIN"}}%   

USUARIOS PONER SIEMPRE AL INICIAR CHAT

üîó URLS IMPORTANTES (GU√ÅRDALAS)

P√∫blic 
postgresql://postgres:qcBdmEnnndcUMfsXjaoRkXXYRwwgqgmV@hopper.proxy.rlwy.net:23359/railway

postgresql://postgres:qcBdmEnnndcUMfsXjaoRkXXYRwwgqgmV@postgres.railway.internal:5432/railway

Frontend (producci√≥n):
https://lpmbe-frontend.vercel.app
Backend (producci√≥n):
https://lpbme-backend-production.up.railway.app
Ejemplo endpoint real:
https://lpbme-backend-production.up.railway.app/notificaciones

üìò BIBLIA DEFINITIVA LPBME MULTIMEDIA, FOTOS Y MULTIEXPERIENCIAS

Multimedia ¬∑ Multiexperiencias ¬∑ Paradas ¬∑ POIs ¬∑ Legacy

Este documento es la fuente de verdad del sistema LPBME 2.0 en lo relativo a:
	‚Ä¢	multiexperiencias
	‚Ä¢	paradas (hijas)
	‚Ä¢	multimedia
	‚Ä¢	relaci√≥n entre sistema nuevo y legacy WordPress

Si en alg√∫n momento algo ‚Äúno sale‚Äù, la respuesta est√° aqu√≠.

‚∏ª

1. PRINCIPIO FUNDAMENTAL DEL SISTEMA

LPBME no tiene un √∫nico modelo de datos para el contenido tur√≠stico.

Conviven dos sistemas:

A) Sistema NUEVO (Prisma / Nest / Next / App)
	‚Ä¢	Usuarios
	‚Ä¢	Pueblos
	‚Ä¢	Multiexperiencias padre
	‚Ä¢	Visitas, puntos, gamificaci√≥n
	‚Ä¢	Casa del usuario
	‚Ä¢	Mapa
	‚Ä¢	Club de Amigos

B) Sistema LEGACY (WordPress / JetEngine)
	‚Ä¢	Paradas de multiexperiencias
	‚Ä¢	Fotos hist√≥ricas
	‚Ä¢	Textos largos
	‚Ä¢	POIs hist√≥ricos
	‚Ä¢	Coordenadas originales

üëâ Nada est√° ‚Äúmal‚Äù: simplemente hay que leer cada cosa de donde toca.

‚∏ª

2. PUEBLOS

2.1 Tabla Pueblo
	‚Ä¢	IDs bajos: 1‚Äì126
	‚Ä¢	Fuente oficial de:
	‚Ä¢	nombre
	‚Ä¢	slug
	‚Ä¢	lat / lng
	‚Ä¢	datos administrativos

2.2 Fotos del pueblo

üìå Fuente √∫nica correcta: tabla Foto

Tabla Foto:
	‚Ä¢	id
	‚Ä¢	url
	‚Ä¢	alt
	‚Ä¢	orden
	‚Ä¢	puebloId

Regla:

Fotos del pueblo = Foto WHERE puebloId = Pueblo.id

‚úîÔ∏è Esto funciona
‚úîÔ∏è No depende de legacy
‚úîÔ∏è No se toca

‚∏ª

3. MULTIEXPERIENCIAS PADRE

3.1 Tabla Multiexperiencia (NUEVA)

Ejemplos:
	‚Ä¢	A√≠nsa, pueblo de Leyenda
	‚Ä¢	Ilustres contempor√°neos
	‚Ä¢	Un recorrido m√°gico‚Ä¶

Campos clave:
	‚Ä¢	id
	‚Ä¢	titulo
	‚Ä¢	slug
	‚Ä¢	foto ‚úÖ
	‚Ä¢	relaciones con pueblo v√≠a PuebloMultiexperiencia

3.2 Relaci√≥n con pueblos

Tabla: PuebloMultiexperiencia

Campos:
	‚Ä¢	puebloId
	‚Ä¢	multiexperienciaId
	‚Ä¢	orden

Regla:

Una multiexperiencia padre pertenece a uno o varios pueblos


‚∏ª

4. MULTIEXPERIENCIAS HIJAS (PARADAS)

‚ö†Ô∏è PUNTO M√ÅS IMPORTANTE DEL SISTEMA

4.1 D√≥nde viven REALMENTE las paradas

üëâ NO viven en Poi
üëâ Viven en LEGACY

Las paradas son IDs ALTOS (ej. 2102, 2145, 2597‚Ä¶)

‚∏ª

5. MODELO LEGACY DE MULTIEXPERIENCIAS

5.1 wp_multiexperiencias_legacy

Define el padre legacy por pueblo.

Campos clave:
	‚Ä¢	_ID ‚Üí legacy_parent_id
	‚Ä¢	nombre
	‚Ä¢	id_lugar ‚Üí puebloId
	‚Ä¢	tipo = 'Pueblo'
	‚Ä¢	imagen (foto del padre)

Ejemplo:

A√≠nsa ‚Üí _ID = 50, id_lugar = 37


‚∏ª

5.2 wp_multiexperiencias_pueblos_legacy

Define las hijas (paradas).

Campos:
	‚Ä¢	id_multiexperiencia ‚Üí legacy_parent_id
	‚Ä¢	id_pueblo ‚Üí ID ALTO de la parada

Ejemplo:

50 ‚Üí [2102, 2103, 2104, 2105, 2106]


‚∏ª

6. DATOS DE UNA PARADA (HIJA)

Para cada id_pueblo_alto:

6.1 Nombre y coordenadas

Tabla: wp_lugar_legacy

Campos:
	‚Ä¢	legacy_lugar_id
	‚Ä¢	latitud
	‚Ä¢	longitud
	‚Ä¢	(y variantes coordenadas_*)

Regla:

Lat/Lng de parada = wp_lugar_legacy WHERE legacy_lugar_id = id_pueblo_alto

‚úîÔ∏è No dependemos de Poi
‚úîÔ∏è Coordenadas fiables

‚∏ª

6.2 Texto descriptivo

Tabla: legacy_descripcion

Campos:
	‚Ä¢	legacy_lugar_id
	‚Ä¢	descripcion_html

Regla:

Texto de parada = legacy_descripcion WHERE legacy_lugar_id = id_pueblo_alto


‚∏ª

6.3 Foto de la parada

Tabla: wp_multimedia_legacy

Campos:
	‚Ä¢	id_lugar
	‚Ä¢	tipo
	‚Ä¢	url

Regla:

Foto de parada =
  wp_multimedia_legacy
  WHERE id_lugar = id_pueblo_alto
  AND tipo = 'Imagen'

‚úîÔ∏è Confirmado en producci√≥n
‚úîÔ∏è Todas las paradas tienen foto

‚∏ª

7. POIs (PUNTOS DE INTER√âS)

7.1 Tabla Poi

Contiene:
	‚Ä¢	POIs reales
	‚Ä¢	restos hist√≥ricos
	‚Ä¢	antiguas ‚Äúparadas‚Äù duplicadas

Campos:
	‚Ä¢	id
	‚Ä¢	nombre
	‚Ä¢	categoria ‚Üí POI | MULTIEXPERIENCIA
	‚Ä¢	puebloId
	‚Ä¢	lat / lng
	‚Ä¢	foto ‚ùå (siempre NULL)

‚∏ª

7.2 Fotos de POIs

üìä Estado real:
	‚Ä¢	POIs totales: 622
	‚Ä¢	POIs con foto legacy: 125
	‚Ä¢	POIs sin foto: 497

Regla:

Foto POI =
  wp_multimedia_legacy
  WHERE id_lugar = Poi.id

Si no hay ‚Üí no hay foto (dato hist√≥rico).

‚∏ª

8. SOBRE Poi.categoria = 'MULTIEXPERIENCIA'

‚ö†Ô∏è NO ES FUENTE DE VERDAD

Problemas detectados:
	‚Ä¢	multiexperienciaId contaminado
	‚Ä¢	IDs mezclados entre pueblos
	‚Ä¢	multis ‚Äúnacionales‚Äù mal representadas

Decisi√≥n:

Poi.MULTIEXPERIENCIA = obsoleto para paradas

No se usa para:
	‚Ä¢	fotos
	‚Ä¢	texto
	‚Ä¢	estructura de paradas

‚∏ª

9. REGLA DEFINITIVA DE LECTURA (PRODUCCI√ìN SEGURA)

üîπ Multiexperiencia PADRE
	‚Ä¢	Fuente: Multiexperiencia (nueva)

üîπ Paradas (HIJAS)
	‚Ä¢	Fuente: 100% LEGACY
	‚Ä¢	estructura ‚Üí wp_multiexperiencias_*
	‚Ä¢	coords ‚Üí wp_lugar_legacy
	‚Ä¢	texto ‚Üí legacy_descripcion
	‚Ä¢	foto ‚Üí wp_multimedia_legacy

üîπ POIs normales
	‚Ä¢	Fuente: Poi
	‚Ä¢	Foto: legacy si existe

‚∏ª

10. CONSECUENCIA CLAVE

No hay que:
	‚Ä¢	migrar datos ahora
	‚Ä¢	limpiar legacy ahora
	‚Ä¢	tocar producci√≥n

Solo hay que:
üëâ leer bien

‚∏ª

üìå  BIBLIA de pois

BIBLIA (DOCUMENTACI√ìN CAN√ìNICA) ‚Äî C√ìMO SE OBTIENEN POIs, FOTOS Y DESCRIPCIONES
	1.	Problema original (por qu√© ‚ÄúMoj√°car en Albarrac√≠n‚Äù)

	‚Ä¢	Los POIs del sistema nuevo (Poi) NO contienen los IDs legacy que apuntan a fotos y descripciones.
	‚Ä¢	Las fotos y descripciones en WordPress est√°n ‚Äúcolgadas‚Äù de un identificador legacy de ‚ÄúLugar‚Äù (CCT Lugares).
	‚Ä¢	Error t√≠pico: buscar multimedia con idLugar = Poi.id (mal). Eso mezcla contenido porque Poi.id no tiene relaci√≥n con los IDs legacy.

	2.	Fuentes de datos (tablas) y qu√© representa cada una

2.1 Tabla nueva (LPBME)
	‚Ä¢	Poi
	‚Ä¢	POI operativo en el sistema nuevo.
	‚Ä¢	Campos: id, nombre, puebloId, categoria, lat, lng, etc.
	‚Ä¢	Importante: Poi NO trae foto/descr legacy ‚Äúde serie‚Äù.

2.2 Tablas legacy (WordPress espejo)
	‚Ä¢	LugarLegacy
	‚Ä¢	Representa ‚ÄúLugares‚Äù legacy (incluye POIs de pueblo).
	‚Ä¢	Clave principal: LugarLegacy.id (BigInt)  ‚Üê ESTE es el ID maestro legacy.
	‚Ä¢	Vinculaci√≥n a pueblo: LugarLegacy.puebloid (Int) = ID del pueblo (ej: 37 A√≠nsa).
	‚Ä¢	Flags para clasificar:
	‚Ä¢	poiPueblo = true  (POI de pueblo)
	‚Ä¢	poiMultiexperiencia = false (NO parada de multiexperiencia)
	‚Ä¢	Ejemplo can√≥nico:
	‚Ä¢	LugarLegacy.id = 1350 ‚Üí ‚ÄúCastillo de A√≠nsa‚Äù
	‚Ä¢	LugarLegacy.puebloid = 37 ‚Üí A√≠nsa
	‚Ä¢	MultimediaLegacy
	‚Ä¢	Multimedia legacy (im√°genes, v√≠deos, etc.)
	‚Ä¢	Clave de uni√≥n:
	‚Ä¢	MultimediaLegacy.idLugar (BigInt) = LugarLegacy.id
	‚Ä¢	Para POIs: nos interesan filas con tipo='Imagen' y normalmente cctStatus='publish'.
	‚Ä¢	La URL final suele estar en url (o el campo que ya est√°s usando).
	‚Ä¢	legacy_descripcion
	‚Ä¢	Descripciones HTML legacy.
	‚Ä¢	Clave de uni√≥n:
	‚Ä¢	legacy_descripcion.legacy_lugar_id (BigInt) = LugarLegacy.id
	‚Ä¢	Campo clave:
	‚Ä¢	descripcion_html (HTML para pintar)
	‚Ä¢	Selecci√≥n:
	‚Ä¢	primero tipo='Larga' (si existe)
	‚Ä¢	si no, cualquier tipo
	‚Ä¢	Filtrar por cct_status='publish' cuando aplique.

	3.	Clave del sistema: Poi.legacyLugarId

	‚Ä¢	Se a√±adi√≥ Poi.legacyLugarId (BigInt?) para guardar el LugarLegacy.id correcto.
	‚Ä¢	Esta es la uni√≥n can√≥nica:
	‚Ä¢	Poi.legacyLugarId  ‚Üí LugarLegacy.id

	4.	C√≥mo se asigna legacyLugarId (backfill)

	‚Ä¢	Se busca el LugarLegacy correcto usando:
	‚Ä¢	mismo pueblo: LugarLegacy.puebloid = Poi.puebloId
	‚Ä¢	mismo nombre (o estrategia equivalente): LugarLegacy.nombre = Poi.nombre
	‚Ä¢	y filtros:
	‚Ä¢	poiPueblo=true
	‚Ä¢	poiMultiexperiencia=false
	‚Ä¢	Resultado:
	‚Ä¢	La mayor√≠a de POIs quedan enlazados (en vuestro caso ~599/622).

	5.	C√≥mo se obtiene la FOTO (fotoUrl) para un POI
Entrada:

	‚Ä¢	poi.legacyLugarId

Proceso:
	‚Ä¢	Buscar primera imagen en MultimediaLegacy con:
	‚Ä¢	idLugar = poi.legacyLugarId
	‚Ä¢	tipo='Imagen'
	‚Ä¢	(opcional) cctStatus='publish'
	‚Ä¢	Elegir 1 imagen estable:
	‚Ä¢	orden por id asc (o por fecha si ten√©is una)
Salida:
	‚Ä¢	fotoUrl = multimedia.url (o el campo URL equivalente)
Si no hay filas:
	‚Ä¢	fotoUrl = null

Regla de oro:
	‚Ä¢	Nunca buscar por idLugar = Poi.id.

	6.	C√≥mo se obtiene la DESCRIPCI√ìN (descripcionHtml) para un POI
Entrada:

	‚Ä¢	poi.legacyLugarId

Proceso:
	1.	Buscar descripci√≥n ‚ÄúLarga‚Äù

	‚Ä¢	legacy_descripcion where:
	‚Ä¢	legacy_lugar_id = poi.legacyLugarId
	‚Ä¢	cct_status='publish'
	‚Ä¢	tipo='Larga'

	2.	Si no existe, buscar cualquiera

	‚Ä¢	legacy_descripcion where:
	‚Ä¢	legacy_lugar_id = poi.legacyLugarId
	‚Ä¢	cct_status='publish'

Salida:
	‚Ä¢	descripcionHtml = descripcion_html
Si no hay filas:
	‚Ä¢	descripcionHtml = null

	7.	BigInt y por qu√© os daba 500

	‚Ä¢	Prisma devuelve BigInt en campos como LugarLegacy.id / idLugar / legacy_lugar_id.
	‚Ä¢	Express/Nest al hacer res.json() revienta si cualquier BigInt llega al response:
	‚Ä¢	‚ÄúDo not know how to serialize a BigInt‚Äù
Soluciones can√≥nicas:
	‚Ä¢	No devolver BigInt en respuestas p√∫blicas, o convertirlo a string.
	‚Ä¢	Y/o parche global BigInt.prototype.toJSON.

	8.	Qu√© NO se toca

	‚Ä¢	Multiexperiencias: intactas (no se alteran reglas ni queries).
	‚Ä¢	La l√≥gica POI se basa solo en el enlace legacy v√≠a LugarLegacy.

	9.	Verificaci√≥n r√°pida (can√≥nica)

	‚Ä¢	Caso A√≠nsa:
	‚Ä¢	Poi (Castillo de A√≠nsa) ‚Üí legacyLugarId = 1350
	‚Ä¢	MultimediaLegacy.idLugar=1350 devuelve foto correcta
	‚Ä¢	legacy_descripcion.legacy_lugar_id=1350 devuelve HTML correcto



TUTORIAL 

Voy a analizar la estructura del frontend para identificar el sistema de gesti√≥n y preparar la implementaci√≥n de POIs:

[10 tools called]

Perfecto, he analizado toda la estructura del frontend. Aqu√≠ est√° el **mapa completo del sistema de gesti√≥n**:

---

## üìã **AN√ÅLISIS COMPLETO DEL SISTEMA DE GESTI√ìN**

### **1. ESTRUCTURA DE RUTAS (PAGE.TSX)**

#### **Gesti√≥n Principal:**
```
/gestion/
‚îú‚îÄ‚îÄ page.tsx                           (Dashboard principal)
‚îú‚îÄ‚îÄ mis-pueblos/page.tsx               (Lista de pueblos del alcalde)
‚îú‚îÄ‚îÄ eventos/page.tsx                   (Eventos globales)
‚îî‚îÄ‚îÄ noticias/page.tsx                  (Noticias globales)
```

#### **Gesti√≥n por Pueblo:**
```
/gestion/pueblos/[slug]/
‚îú‚îÄ‚îÄ page.tsx                           ‚≠ê MEN√ö PRINCIPAL (shell con links)
‚îú‚îÄ‚îÄ noticias/page.tsx                  (Noticias del pueblo)
‚îú‚îÄ‚îÄ eventos/page.tsx                   (Eventos del pueblo)
‚îú‚îÄ‚îÄ alertas/page.tsx                   (Alertas del pueblo)
‚îú‚îÄ‚îÄ semaforo/page.tsx                  (Sem√°foro del pueblo)
‚îú‚îÄ‚îÄ club/page.tsx                      (Club de Amigos)
‚îú‚îÄ‚îÄ fotos/page.tsx                     ‚≠ê PATR√ìN FOTOS (copiar para POIs)
‚îî‚îÄ‚îÄ descripcion/page.tsx               (Descripci√≥n del pueblo)
```

#### **Gesti√≥n Asociaci√≥n (ADMIN):**
```
/gestion/asociacion/
‚îú‚îÄ‚îÄ page.tsx
‚îú‚îÄ‚îÄ alertas/page.tsx
‚îú‚îÄ‚îÄ eventos/page.tsx
‚îú‚îÄ‚îÄ noticias/page.tsx
‚îî‚îÄ‚îÄ club/metricas/page.tsx
```

---

### **2. SHELL DE GESTI√ìN (MEN√ö DE PUEBLO)**

**Archivo:** `app/gestion/pueblos/[slug]/page.tsx`

**Estructura actual:**

```56:67:app/gestion/pueblos/[slug]/page.tsx
          <Link className="hover:underline" href={`/gestion/pueblos/${slug}/semaforo`}>
            Sem√°foro
          </Link>
          <Link className="hover:underline" href={`/gestion/pueblos/${slug}/club`}>
            Club de Amigos
          </Link>
          <Link className="hover:underline" href={`/gestion/pueblos/${slug}/fotos`}>
            Fotos del pueblo
          </Link>
          <Link className="hover:underline" href={`/gestion/pueblos/${slug}/descripcion`}>
            Descripci√≥n del pueblo
          </Link>
```

**üëâ Aqu√≠ a√±adiremos:** `Puntos de Inter√©s (POIs)`

---

### **3. PATR√ìN API (BACKEND PROXY)**

**Helper principal:** `lib/api.ts`

```1:6:lib/api.ts
export function getApiUrl(): string {
  return (
    process.env.NEXT_PUBLIC_API_URL?.replace(/\/$/, "") ??
    "http://localhost:3000"
  );
}
```

**Patr√≥n de uso:**
- ‚úÖ `getApiUrl()` ‚Üí `http://localhost:3000` (backend local)
- ‚úÖ Todas las llamadas usan `/api/...` (proxies de Next.js)
- ‚úÖ Los proxies reenv√≠an a `${UPSTREAM}/...` (backend real)

---

### **4. PATR√ìN FOTOS (TEMPLATE PERFECTO PARA POIS)**

#### **A) Server Component (wrapper):**

```1:10:app/gestion/pueblos/[slug]/fotos/page.tsx
import FotosPuebloClient from "./FotosPuebloClient";

export default async function FotosPuebloPage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params;
  return <FotosPuebloClient slug={slug} />;
}
```

#### **B) Client Component (l√≥gica completa):**

```1:100:app/gestion/pueblos/[slug]/fotos/FotosPuebloClient.tsx
"use client";

import { useEffect, useMemo, useState } from "react";

type FotoRow = {
  id: string | number;
  url: string;
  alt?: string | null;
  orden?: number | null;
  origen?: "LEGACY" | "NUEVA" | string;
  activo?: boolean;
  editable?: boolean;
};

export default function FotosPuebloClient({ slug }: { slug: string }) {
  const [puebloId, setPuebloId] = useState<number | null>(null);
  const [loading, setLoading] = useState(true);
  const [err, setErr] = useState<string | null>(null);

  const [rows, setRows] = useState<FotoRow[]>([]);

  const [editId, setEditId] = useState<string | number | null>(null);
  const [editAlt, setEditAlt] = useState("");
  const [editOrden, setEditOrden] = useState<number | "">("");

  const sorted = useMemo(() => {
    const copy = [...rows];
    copy.sort((a, b) => (a.orden ?? 999999) - (b.orden ?? 999999));
    return copy;
  }, [rows]);

  async function fetchPuebloId() {
    const r = await fetch(`/api/pueblos/${encodeURIComponent(slug)}`, { cache: "no-store" });
    if (r.status === 401) {
      window.location.href = "/entrar";
      return null;
    }
    if (!r.ok) throw new Error(`Error cargando pueblo (${r.status})`);
    const data = await r.json();
    if (!data?.id) throw new Error("Pueblo sin id");
    return Number(data.id);
  }

  async function fetchFotos(pid: number) {
    const r = await fetch(`/api/admin/pueblos/${pid}/fotos`, { cache: "no-store" });
    if (r.status === 401) {
      window.location.href = "/entrar";
      return [];
    }
    if (r.status === 403) throw new Error("No autorizado (403)");
    if (!r.ok) throw new Error(`Error cargando fotos (${r.status})`);
    return (await r.json()) as FotoRow[];
  }

  async function refresh() {
    setLoading(true);
    setErr(null);
    try {
      const pid = puebloId ?? (await fetchPuebloId());
      if (!pid) return;
      if (!puebloId) setPuebloId(pid);
      const fotos = await fetchFotos(pid);
      setRows(fotos);
    } catch (e: any) {
      setErr(e?.message ?? "Error");
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    refresh();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [slug]);

  function startEdit(row: FotoRow) {
    setEditId(row.id);
    setEditAlt(row.alt ?? "");
    setEditOrden((row.orden ?? "") as any);
  }

  function cancelEdit() {
    setEditId(null);
    setEditAlt("");
    setEditOrden("");
  }

  async function saveEdit() {
    if (editId == null) return;
    setErr(null);

    const payload: any = {};
    if (typeof editOrden === "number") payload.orden = editOrden;
    if (editAlt.trim()) payload.alt = editAlt.trim();
    if (!editAlt.trim()) payload.alt = ""; // permitir limpiar

    const r = await fetch(`/api/admin/fotos/${editId}`, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
```

**Funcionalidades implementadas:**
- ‚úÖ Cargar lista (legacy + nuevas)
- ‚úÖ A√±adir nueva (prompt)
- ‚úÖ Editar ALT y orden
- ‚úÖ Eliminar (solo editables)
- ‚úÖ Reordenar (‚Üë‚Üì con swap)
- ‚úÖ Badge "Principal" (orden=1)
- ‚úÖ Separaci√≥n legacy/editable

---

### **5. ESTRUCTURA DE API PROXIES (FOTOS)**

```
app/api/admin/
‚îú‚îÄ‚îÄ fotos/
‚îÇ   ‚îî‚îÄ‚îÄ [fotoId]/
‚îÇ       ‚îî‚îÄ‚îÄ route.ts                   (PUT, DELETE individual)
‚îî‚îÄ‚îÄ pueblos/
    ‚îî‚îÄ‚îÄ [puebloId]/
        ‚îú‚îÄ‚îÄ descripcion/
        ‚îÇ   ‚îî‚îÄ‚îÄ route.ts               (GET, PUT descripci√≥n)
        ‚îî‚îÄ‚îÄ fotos/
            ‚îú‚îÄ‚îÄ route.ts               (GET lista, POST nueva)
            ‚îî‚îÄ‚îÄ swap/
                ‚îî‚îÄ‚îÄ route.ts           (POST swap orden)
```

**Patr√≥n de proxy t√≠pico:**
```typescript
import { getToken } from "@/lib/auth";

export async function GET(
  req: Request,
  { params }: { params: Promise<{ puebloId: string }> }
) {
  const { puebloId } = await params;
  const UPSTREAM = process.env.NEXT_PUBLIC_API_URL ?? "http://localhost:3000";
  
  const token = await getToken();
  const headers: HeadersInit = {
    "Content-Type": "application/json",
  };
  if (token) headers["Authorization"] = `Bearer ${token}`;
  
  const res = await fetch(`${UPSTREAM}/admin/pueblos/${puebloId}/fotos`, {
    headers,
    cache: "no-store",
  });
  
  const text = await res.text();
  return new Response(text, {
    status: res.status,
    headers: { "Content-Type": "application/json" },
  });
}
```

---

### **6. PERMISOS Y AUTH**

**Patr√≥n usado en todas las p√°ginas de gesti√≥n:**

```10:25:app/gestion/pueblos/[slug]/page.tsx
export default async function GestionPuebloPage({
  params,
}: {
  params: Promise<{ slug: string }>;
}) {
  const { slug } = await params;
  const me = await getMeServer();
  if (!me) redirect('/entrar');
  if (me.rol !== 'ALCALDE' && me.rol !== 'ADMIN') redirect('/cuenta');

  // Si es ALCALDE, verificamos que el pueblo est√° en su lista.
  if (me.rol === 'ALCALDE') {
    const mis = await getMisPueblosServer();
    const allowed = mis.some((p) => p.slug === slug);
    if (!allowed) redirect('/gestion/mis-pueblos');
  }
```

**Roles:**
- ‚úÖ `ADMIN` ‚Üí Acceso total
- ‚úÖ `ALCALDE` ‚Üí Solo sus pueblos
- ‚úÖ Otros roles ‚Üí Redirigir a `/cuenta`

---

### **7. RESUMEN PARA IMPLEMENTAR POIs**

#### **Archivos a crear (copiando patr√≥n de Fotos):**

```
app/gestion/pueblos/[slug]/pois/
‚îú‚îÄ‚îÄ page.tsx                           (server wrapper)
‚îî‚îÄ‚îÄ PoisPuebloClient.tsx               (client component)

app/api/admin/
‚îú‚îÄ‚îÄ pois/
‚îÇ   ‚îî‚îÄ‚îÄ [poiId]/
‚îÇ       ‚îî‚îÄ‚îÄ route.ts                   (PUT, DELETE)
‚îî‚îÄ‚îÄ pueblos/
    ‚îî‚îÄ‚îÄ [puebloId]/
        ‚îî‚îÄ‚îÄ pois/
            ‚îú‚îÄ‚îÄ route.ts               (GET lista, POST nuevo)
            ‚îî‚îÄ‚îÄ swap/
                ‚îî‚îÄ‚îÄ route.ts           (POST swap orden)
```

#### **A√±adir link en el men√∫:**

```typescript
// En app/gestion/pueblos/[slug]/page.tsx
<Link className="hover:underline" href={`/gestion/pueblos/${slug}/pois`}>
  Puntos de Inter√©s (POIs)
</Link>
```

---

## ‚úÖ **CONCLUSI√ìN**

**Sistema analizado y documentado completamente:**
- ‚úÖ Estructura de rutas mapeada
- ‚úÖ Shell de gesti√≥n identificado
- ‚úÖ Patr√≥n de Fotos documentado (template perfecto)
- ‚úÖ Sistema de API proxies entendido
- ‚úÖ Permisos y auth clarificados

**Listo para implementar POIs siguiendo el patr√≥n exacto de Fotos.** üöÄ


